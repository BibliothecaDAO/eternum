# ü§ñ Resource Automation

Resource automation covers two loops in Blitz: **production automation** (continuous realm/village crafting) and
**transfer automation** (recurring shipments between your entities). This update focuses on the production side, which
recently moved away from ‚Äúorders‚Äù in favor of preset-driven allocations.

## Production Automation at a Glance

- **Global loop**: Every 60 seconds the client evaluates all of your realms/villages and executes any valid production
  plan.
- **Per-resource percentages**: Instead of one-off jobs, each resource has sliders that describe how much of its inputs
  you are willing to burn through complex (resource‚Üíresource) or simple (labor‚Üíresource) recipes.
- **Safety rails**: Inputs are capped at 90% of their current balance, Wheat/Labor outputs are blocked entirely, and
  Donkeys are automatically limited to 10% for complex crafting.
- **Presets**: ‚ÄúLabor‚Äù, ‚ÄúResource‚Äù, ‚ÄúCustom‚Äù, and ‚ÄúIdle‚Äù presets instantly distribute percentages across every resource
  that has active buildings, respecting entity type (realm vs village) and recipe availability.
- **Local persistence**: Configurations are saved per season in your browser. Refreshing or closing the tab keeps the
  latest sliders and last execution summary.

> ‚ö†Ô∏è The automation loop runs inside your browser. Keep the Blitz tab in the foreground (or at least open) whenever you
> expect automation to fire; closing the tab stops both production and transfer processing.

## How the Loop Works

1. **Realm discovery**: On load the client pulls every realm/village you own and ensures each has an automation config.
2. **Resource scan**: Any resource with buildings or active production is auto-added (unless it‚Äôs blocked) so its inputs
   are tracked even if you never touched the sliders.
3. **Budgeting**: For each resource the system computes a ‚Äúbudget‚Äù equal to 90% of its simulated balance at the current
   tick. Percentages merely describe how much of that budget to dedicate to complex vs simple recipes.
4. **Plan generation**:
   - Complex recipes reserve inputs based on your percentage cap and the recipe‚Äôs per-cycle requirement.
   - Labor recipes do the same with their listed inputs. If not enough inputs are available the recipe is skipped and
     appears in the summary.
5. **Execution**: If at least one recipe has non-zero cycles, Blitz submits a single `execute_realm_production_plan`
   Starknet transaction for that realm/village.
6. **Feedback loop**: The store records how many cycles ran, total inputs consumed, outputs produced, and any skipped
   resources so the UI can show ‚Äúlast run‚Äù stats.

### Entity Coverage

- **Realms and Villages** are supported. Hyperstructures and other entity types are ignored by the production loop.
- Each entity gets its own automation profile. Removing ownership (selling, conquest) causes the profile to be pruned.

### Blocked or Special Resources

- **Wheat and Labor outputs** are blocked from automation to prevent runaway feedback loops.
- **Donkeys** default to 10% resource‚Üíresource and 0% labor‚Üíresource. The slider enforces these caps so you always have
  beasts of burden for transfers/military.
- **Input-only restrictions**: Even if an output is blocked, it can still be consumed as an input for other recipes.

## Configuring Production Automation

1. **Open a realm/village** and select the **Automation** panel in the production sidebar.
2. **Review auto-added resources**. Any resource that currently has buildings is already listed with baseline
   percentages. You can remove extras if you want to keep the panel tidy.
3. **Adjust percentages**:
   - `Resource ‚Üí Resource`: How much of that resource‚Äôs complex inputs you are willing to burn per loop.
   - `Labor ‚Üí Resource`: How much labor-based production to run. (Disabled for Donkeys and military-only recipes.)
   - Values are rounded to 5% increments and clamped between 0 and 90%.
4. **Apply presets** (optional):
   - `Labor`: Evenly spreads up to 10% labor burn across eligible outputs while respecting shared inputs.
   - `Resource`: Pushes complex crafting as high as possible (still honoring input caps and blocked resources).
   - `Custom`: Keeps whatever manual sliders you set.
   - `Idle`: Sets every slider to 0%, effectively pausing production for that entity.
5. **Save & repeat** for your other entities. Any slider change is saved immediately and will be used in the next loop.

### Auto-balancing & Maintenance

- When a resource starts producing (new buildings finish) the automation store ensures it has a slider entry so presets
  continue to work. Removing the building later automatically drops the extra entry.
- If you reset an entity the store wipes its allocations but keeps the entity record so you can reconfigure quickly.
- Per-season pruning means you get a clean slate when a new Blitz season launches, avoiding stale configs.

## Execution Summaries

After each successful loop the realm panel shows:

- **Timestamp** of the last run.
- **Produced/Consumed totals** grouped by resource so you can see net flows.
- **Skipped recipes** with reasons (missing inputs, missing labor recipe, etc.).
- **Total cycles** executed across complex and simple recipes.

Use this view to verify slider settings or debug why a resource is not being automated (e.g., labor inputs depleted).

---

## Production Inputs

Automation currently runs two recipe families:

1. **Complex (Resource ‚Üí Resource)**:
   - Burns existing resources to craft another output.
   - Uses the `Resource ‚Üí Resource` slider for each resource entry.
   - Example: Converting Wood + Stone into Tools.
2. **Simple (Labor ‚Üí Resource)**:
   - Spends Labor to produce a resource.
   - Uses the `Labor ‚Üí Resource` slider.
   - Example: Spending Labor to harvest Food.

`Resource ‚Üí Labor` conversions and any recipe that would output Wheat or Labor are blocked from automation entirely.
Those actions must be run manually from the production UI.

## Allocation & Execution Rules

- **Percentages replace orders**: There are no longer bespoke ‚Äúproduce once/maintain‚Äù orders. Every loop recomputes
  usage based on your sliders, entity type, and building activity.
- **Per-resource budgets**: Each resource receives a budget equal to 90% of its simulated balance. The complex and labor
  sliders consume that budget; if either slider is zero the loop skips that recipe.
- **5% increments & clamping**: UI sliders move in 5% increments and are clamped between 0% and 90%. Donkeys are
  additionally capped at 10% resource burn and 0% labor.
- **Auto-managed lists**: Any resource with active production is auto-added to the automation list so presets keep
  working when new buildings finish. Removing the building later prunes the entry.
- **Single transaction per entity**: If at least one recipe has cycles, Blitz submits a single
  `execute_realm_production_plan` transaction for that realm/village and records the execution summary.

---

## Transfer Automation

Transfer automation schedules recurring shipments between structures you own. It runs in-browser alongside production
automation and is stored per season (localStorage key `eternum-transfer-automation`).

### Runner Basics

- **Interval-based**: Each entry stores a source, destination, resource list, and interval. Intervals are clamped between
  5 and 60 minutes (default 30). The runner wakes roughly once per second to check whether an entry‚Äôs `nextRunAt` has
  elapsed.
- **Immediate send + schedule**: When you enable ‚ÄúRepeat‚Äù in the transfer panel, Blitz sends the payload once (if
  possible) and also creates one entry per destination. The first automated run occurs after the selected interval.
- **Resource locking**: Every entry keeps per-resource amounts. Each execution clamps those amounts to live balances and
  available donkey capacity so partial shipments still happen safely.
- **Safety checks**: Military resources can only move Realm ‚Üî Realm. Fragment mines can only send Donkeys/Essence. The
  runner enforces donkey weight limits and ownership checks before submitting Starknet calls. Failed runs are skipped,
  rescheduled, and surfaced via toasts.
- **Season pruning**: Switching seasons automatically prunes stored entries that do not match the current game ID.

### Creating a Scheduled Transfer

1. **Choose a source**: Realms, Villages, and Fragment Mines you own appear in the ‚ÄúTransfer‚Äù panel. Fragment Mines are
   restricted to Donkeys + Essence payloads.
2. **Pick resources & amounts**: Select up to the resources currently held at the source. Amount inputs are whole-number
   units and the panel previews donkey demand so you can stay within available capacity.
3. **Select destinations**:
   - When only one resource is selected you may multi-select destinations; Blitz creates one entry per destination.
   - With multiple resources the panel enforces a single destination.
   - Military payloads auto-filter destinations to Realms only.
4. **Set frequency**:
   - `One-off` fires a single `send_resources_multiple` call (no automation entry).
   - `Repeat` executes immediately and schedules future runs at the chosen 5‚Äë60 minute interval.
5. **Create transfers**: Confirm to send the immediate shipment (if possible) and persist the scheduled entries.

### Managing Scheduled Transfers

Open the **Scheduled Transfers** (Advanced) modal to control saved entries:

- Filter by source/destination, run any entry immediately, or delete it.
- Pause/resume individual entries; pausing clears `nextRunAt` until you resume.
- Bulk actions let you pause all, resume all, or run every active entry once. Manual runs obey the same donkey and
  resource checks as the automated loop.

### Transfer Requirements & Safeguards

- Sources and destinations must be structures you own. The UI only lists owned entities and the runner double-checks
  IDs before calling `send_resources_multiple`.
- Donkey supply is mandatory. The runner converts the requested payload into kilograms, calls `calculateDonkeysNeeded`,
  and skips the entry if the source lacks enough Donkeys.
- Entries reschedule themselves even when a run transacts zero resources (e.g., source empty). Keep an eye on toasts to
  know when an entry is repeatedly skipped.
- Resource amounts are integer units; decimals are rounded down. Each run clamps to the current balance, so you can
  safely request more than is presently available.
- Multi-destination setups are represented internally as one entry per destination so each route tracks its own
  `lastRunAt`/`nextRunAt`.

## Important Considerations

### General Requirements

- **Browser Must Be Open**: Automation processing occurs in your browser. If you close the game tab or your browser,
  automated processes will stop.
- **Loop Cadence**: Production automation evaluates every ~60 seconds. The transfer runner polls roughly once per second
  but only fires entries whose 5‚Äë60 minute interval has elapsed.
- **Transaction Costs**: Each successful automation cycle that results in production or transfer will involve a
  blockchain transaction, which incurs network transaction fees.
- **Processing Time**: On-chain confirmation time plus wallet prompts can add delay after an automation cycle triggers.
  Keep notifications enabled so you can approve transactions promptly.

### Production Automation Considerations

- **Resource Availability**: Production orders will only execute if the required input resources are available in the
  realm at the time of processing.
- **Recipe Dependencies**: Production follows predefined game recipes. You cannot produce resources that don't have
  valid recipes.
- **Storage Limits**: Produced resources will increase your realm's balance and may cause resource loss if storage is
  full.
- **Season Reset**: Production allocations are saved locally per season. When a new Blitz season starts your old
  configurations are pruned to avoid stale data.

### Transfer Automation Considerations

- **Entity Ownership**: You can only set up transfers between entities you own.
- **Interval Limits**: Every scheduled entry enforces a 5‚Äë60 minute interval. Values below 5 minutes are raised to 5 and
  anything above 60 minutes is clamped down.
- **Resource & Donkey Checks**: Each run clamps requested amounts to the source‚Äôs current balance and donkey capacity. If
  either requirement fails, the entry is skipped and rescheduled.
- **Payload Restrictions**: Military resources require Realm ‚Üî Realm routes. Fragment mines may only ship Donkeys and
  Essence.
- **Per-Route Tracking**: Multi-destination setups become discrete entries. Pausing or deleting one route does not
  affect the others.

### Best Practices

1. **Start Simple**: Begin with conservative production percentages or a single transfer route to validate your setup.
2. **Monitor Initially**: Watch the first few executions (and wallet prompts) to confirm inputs, outputs, and donkey
   usage match expectations.
3. **Leverage Presets**: Use the Labor/Resource/Idle presets to quickly reset entities instead of dragging dozens of
   sliders.
4. **Use the Advanced Modal**: Pause/resume or run transfer entries from the Scheduled Transfers modal before leaving
   the game idle.
5. **Audit Resource Flows**: Review execution summaries and transfer toasts periodically to ensure automation is still
   aligned with your current goals.
