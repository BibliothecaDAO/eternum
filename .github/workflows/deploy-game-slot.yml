name: ðŸš€ Deploy Eternum on Slot

# Configuration Variables - Update these as needed
env:
  BRANCH: "blitz"
  SLOT_NAME: "eternum-blitz-slot-1"
  SLOT_TEAM: "realms-eternum"
  SLOT_AUTH: ${{ secrets.SLOT_AUTH }}
  SLOT_TIER: "pro"
  TORII_VERSION: "v1.6.0-alpha.2"
  TORII_CONFIG: "torii-slot.toml"
  NODE_VERSION: "18"
  CI: "true"

on:
  schedule:
    - cron: '8 0,5,10,15,20 * * 0,2,4,6'     # Sunday, Tuesday, Thursday, Saturday: 12:08am, 5:08am, 10:08am, 3:08pm, 8:08pm (5 runs)
    - cron: '8 2,7,12,17 * * 1,3,5'     # Monday, Wednesday, Friday: 2:08am, 7:08am, 12:08pm, 5:08pm (4 runs)
  workflow_dispatch:
    inputs:
      slot_name:
        description: 'Slot deployment name'
        required: false
        default: 'eternum-blitz-slot-1'
      torii_version:
        description: 'Torii version to deploy'
        required: false
        default: 'v1.6.0-alpha.2'


jobs:
  deploy-slot:
    name: ðŸŽ¯ Deploy New Game on Slot
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH }}
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ðŸ³ Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: ðŸ”§ Setup Scarb
        uses: software-mansion/setup-scarb@v1
        with:
          scarb-version: "2.10.1"

      - name: ðŸ“¥ Download Dojo Release
        run: |
          curl -L -o dojo-linux-x86_64.tar.gz https://github.com/dojoengine/dojo/releases/download/v1.6.0-alpha.2/dojo_v1.6.0-alpha.2_linux_amd64.tar.gz
          tar -xzf dojo-linux-x86_64.tar.gz
          sudo mv sozo /usr/local/bin/

      - name: ðŸŽ° Install Slot CLI
        run: |
          echo "ðŸŽ° Installing Slot CLI..."
          
          # Install slotup (slot version manager)
          curl -L https://slot.cartridge.sh | bash
          
          # Run slotup to install slot
          echo "ðŸš€ Running slotup to install slot..."
          /home/runner/.config/.slot/bin/slotup
          
          # Add to PATH for subsequent steps
          echo "/home/runner/.config/.slot/bin" >> $GITHUB_PATH
          export PATH="/home/runner/.config/.slot/bin:$PATH"
          
          # Verify slot command works
          slot --version
          echo "âœ… Slot CLI installed successfully"

      - name: ðŸ“š Install Dependencies
        run: pnpm install

      - name: â° Calculate Game Start Time
        id: game-timing
        run: |
          # Calculate game start time: round down to current hour, then add 2 hours 30 minutes (Unix timestamp)
          CURRENT_HOUR_START=$(date -d "$(date '+%Y-%m-%d %H:00:00')" +%s)
          GAME_START_TIMESTAMP=$((CURRENT_HOUR_START + 9000))
          GAME_START_READABLE=$(date -d "@$GAME_START_TIMESTAMP" -u '+%Y-%m-%d %H:%M:%S UTC')
          
          echo "ðŸ• Game start time set to: $GAME_START_READABLE"
          echo "ðŸ• Unix timestamp: $GAME_START_TIMESTAMP"
          
          echo "timestamp=$GAME_START_TIMESTAMP" >> $GITHUB_OUTPUT
          echo "readable=$GAME_START_READABLE" >> $GITHUB_OUTPUT

      - name: ðŸŽ² Generate New Seed
        id: generate-seed
        working-directory: ./contracts/game
        run: |
          # Generate a new random seed with timestamp
          NEW_SEED="s1_eternum_slot_$(date +%s)"
          echo "new_seed=$NEW_SEED" >> $GITHUB_OUTPUT
          echo "ðŸŽ² Generated new seed: $NEW_SEED"

      - name: ðŸ”„ Update Seed in dojo_slot.toml
        working-directory: ./contracts/game
        run: |
          # Update the seed in dojo_slot.toml
          sed -i 's/^seed = ".*"/seed = "${{ steps.generate-seed.outputs.new_seed }}"/' dojo_slot.toml
          echo "âœ… Updated seed in dojo_slot.toml"
          
          # Verify the change
          grep "^seed = " dojo_slot.toml

      - name: ðŸ—ï¸ Run Game Migration
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 20
          max_attempts: 10
          retry_on: error
          on_retry_command: echo "Retrying game migration due to network error (possibly 504 Gateway Timeout)..."
          command: |
            cd contracts
            echo "ðŸš€ Starting game migration for slot..."
            pnpm run game:migrate:slot

      - name: âš™ï¸ Deploy Configuration
        working-directory: ./contracts
        run: |
          CONFIG_START_MAIN_AT="${{ steps.game-timing.outputs.timestamp }}"
          export CONFIG_START_MAIN_AT

          echo "ðŸ”§ Deploying slot configuration..."
          echo "ðŸ• Game will start at: ${{ steps.game-timing.outputs.readable }}"
          pnpm run config:deploy:slot

      - name: ðŸŒ Update Torii Configuration
        working-directory: ./contracts
        run: |
          echo "ðŸ“ Updating Torii configuration with contract addresses and world address..."
          pnpm run toml:update:slot

      - name: ðŸ—‘ï¸ Delete Existing Torii Slot
        continue-on-error: true
        run: |
          SLOT_NAME="${{ github.event.inputs.slot_name || env.SLOT_NAME }}"
          echo "ðŸ—‘ï¸ Attempting to delete existing slot: $SLOT_NAME"
          slot d delete $SLOT_NAME torii -f || echo "âš ï¸ Slot deletion failed or slot doesn't exist"

      - name: ðŸ†• Create New Torii Slot
        run: |
          SLOT_NAME="${{ github.event.inputs.slot_name || env.SLOT_NAME }}"
          TORII_VERSION="${{ github.event.inputs.torii_version || env.TORII_VERSION }}"
          
          echo "ðŸ†• Creating new Torii slot with configuration:"
          echo "  Slot Name: $SLOT_NAME"
          echo "  Team: ${{ env.SLOT_TEAM }}"
          echo "  Tier: ${{ env.SLOT_TIER }}"
          echo "  Version: $TORII_VERSION"
          echo "  Config: ${{ env.TORII_CONFIG }}"
          
          cd contracts/game && slot d create -f \
            --team ${{ env.SLOT_TEAM }} \
            --tier ${{ env.SLOT_TIER }} \
            $SLOT_NAME torii \
            --version $TORII_VERSION \
            --config ${{ env.TORII_CONFIG }}

      - name: ðŸ’¾ Commit and Push Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add config contracts
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸš€: New Blitz Deployment on Slot using ${{ env.BRANCH }} branch"
            git push
          fi

      - name: ðŸ“Š Deployment Summary
        run: |
          echo "## ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Seed** | âœ… Updated | \`${{ steps.generate-seed.outputs.new_seed }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Game Migration** | âœ… Completed | Slot profile |" >> $GITHUB_STEP_SUMMARY
          echo "| **Configuration** | âœ… Deployed | Slot environment |" >> $GITHUB_STEP_SUMMARY
          echo "| **Game Start Time** | ðŸ• Scheduled | ${{ steps.game-timing.outputs.readable }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Torii Slot** | âœ… Created | \`${{ github.event.inputs.slot_name || env.SLOT_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ðŸ“¦ ${{ github.event.inputs.torii_version || env.TORII_VERSION }} | Latest deployment |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment completed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: ðŸš¨ Notify on Failure
        if: failure()
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The slot deployment encountered an error. Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY 