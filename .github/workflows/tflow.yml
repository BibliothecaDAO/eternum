name: üöÄ Test WKF

# Configuration Variables - Update these as needed
env:
  BRANCH: "blitz"
  SLOT_NAME: "eternum-blitz-slot-1"
  SLOT_TEAM: "realms-eternum"
  SLOT_AUTH: ${{ secrets.SLOT_AUTH }}
  SLOT_TIER: "pro"
  TORII_VERSION: "v1.6.0-alpha.2"
  TORII_CONFIG: "torii-slot.toml"
  NODE_VERSION: "18"
  CI: "true"

on:
  schedule:
    - cron: '0 0,5,10,15,20 * * 0,2,4,6'     # Sunday, Tuesday, Thursday, Saturday: 12am, 5am, 10am, 3pm, 8pm (5 runs)
    - cron: '0 2,7,12,17 * * 1,3,5'     # Monday, Wednesday, Friday: 2am, 7am, 12pm, 5pm (4 runs)
  workflow_dispatch:
    inputs:
      slot_name:
        description: 'Slot deployment name'
        required: false
        default: 'eternum-blitz-slot-1'
      torii_version:
        description: 'Torii version to deploy'
        required: false
        default: 'v1.6.0-alpha.2'


jobs:
  deploy-slot:
    name: üéØ Deploy New Game on Slot
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH }}
          fetch-depth: 0

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: ‚è∞ Calculate Game Start Time
        id: game-timing
        run: |
          # Calculate game start time: round down to current hour, then add 2 hours 30 minutes (Unix timestamp)
          CURRENT_HOUR_START=$(date -d "$(date '+%Y-%m-%d %H:00:00')" +%s)
          GAME_START_TIMESTAMP=$((CURRENT_HOUR_START + 9000))
          GAME_START_READABLE=$(date -d "@$GAME_START_TIMESTAMP" -u '+%Y-%m-%d %H:%M:%S UTC')
          
          echo "üïê Game start time set to: $GAME_START_READABLE"
          echo "üïê Unix timestamp: $GAME_START_TIMESTAMP"
          
          echo "timestamp=$GAME_START_TIMESTAMP" >> $GITHUB_OUTPUT
          echo "readable=$GAME_START_READABLE" >> $GITHUB_OUTPUT
    
      - name: ‚öôÔ∏è Deploy Configuration Test
        working-directory: ./contracts
        run: |
          CONFIG_START_MAIN_AT="${{ steps.game-timing.outputs.timestamp }}"
          export CONFIG_START_MAIN_AT

          echo "readable: ${{ steps.game-timing.outputs.readable }}"
          echo "now logging the environment variable"
          echo "config_start_main_at: $CONFIG_START_MAIN_AT"